#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
buildpack="$(cd -P "$(dirname "$0")" && pwd)"

source "${buildpack}/common.sh"

if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

HARFANG_PATH="$BUILD_DIR/harfang"
TMP_PATH="$BUILD_DIR/tmp"
mkdir -p "${BUILD_DIR}/bin" "${CACHE_DIR}/dist" "${TMP_PATH}"
export PATH="$BUILD_DIR/bin:$PATH"

STACK="${STACK:-scalingo-24}"

start "Install Harfang"

install_harfang

if [[ -f "$ENV_DIR/HARFANG_VERSION" ]]; then
  HARFANG_VERSION=$(cat "$ENV_DIR/HARFANG_VERSION")
else
  HARFANG_VERSION="latest"
fi

if [[ $HARFANG_VERSION == "latest" ]]; then
  HARFANG_VERSION=$(fetch_github_latest_release "${TMP_PATH}" "harfang/harfang")
fi

if [ ! -d "${HARFANG_PATH}" ]; then
  if [[ -n "${HARFANG_VERSION}" ]]; then
    fetch_HARFANG_dist "${HARFANG_VERSION}" "${TMP_PATH}" | indent
    mv "${TMP_PATH}/harfang-${HARFANG_VERSION}" "${HARFANG_PATH}"
  fi
else
  warn "Harfang already installed"
fi
info "Using Harfang version: ${HARFANG_VERSION}" | indent
finished

step "Cleaning up tmp files"
rm -rf "${TMP_PATH}"

finished
